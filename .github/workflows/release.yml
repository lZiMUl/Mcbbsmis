name: Release

on:
  push:
    branches:
      - release/*

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: write
      packages: write

    env:
      GIT_USER_NAME: ${{ vars.GIT_USER_NAME }}
      GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Configure git user
        run: |
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"

      - name: Get repository name
        id: repository
        run: echo "name=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)" >> $GITHUB_OUTPUT

      - name: Set remote repository url
        run: git remote set-url origin https://x-access-token:${{ secrets.GH_RELEASE_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/heads/release/}" >> $GITHUB_OUTPUT

      - name: Import GPG key
        run: |
          mkdir -p ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          chmod 700 ~/.gnupg

      - name: Get GPG key ID
        id: key
        run: |
          KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F':' '/^sec/ {print $5}')
          echo "id=$KEY_ID" >> $GITHUB_OUTPUT

      - name: Configure Git GPG
        run: |
          git config gpg.program gpg
          git config user.signingkey ${{ steps.key.outputs.id }}
          git config commit.gpgsign true

      - name: Create signed tag
        run: |
          echo "$GPG_PASSPHRASE" | gpg \
            --batch \
            --yes \
            --pinentry-mode loopback \
            --passphrase-fd 0 \
            -u ${{ steps.key.outputs.id }} \
            -s -b -o /dev/null
          git tag -s v${{ steps.version.outputs.version }} \
            -m "Release v${{ steps.version.outputs.version }}" \
            --local-user ${{ steps.key.outputs.id }}

      - name: Push tag
        run: git push origin v${{ steps.version.outputs.version }}

      - name: Extract changelog for current or latest version
        id: changelog
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
          SELECTED_VERSION="$VERSION"
          else
          SELECTED_VERSION=$(grep -Eo '^## \[[0-9]+\.[0-9]+\.[0-9]+([-+][A-Za-z0-9.-]+)?\]' CHANGELOG.md | head -n 1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+([-+][A-Za-z0-9.-]+)?')
          fi
          echo "Using version: $SELECTED_VERSION"
          changelog=$(awk -v ver="$SELECTED_VERSION" '
          $0 ~ ("## \\[" ver "\\]") {flag=1; next} 
          /^## \[/ && flag {flag=0} 
          flag
          ' CHANGELOG.md)
          echo "changelog<<EOF_CHANGLOG" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF_CHANGLOG" >> $GITHUB_OUTPUT

      - name: Zip Selected Files and Folders
        id: zip
        run: |
          FILE_NAME="${{ steps.repository.outputs.name }}@${{ steps.version.outputs.version }}.zip"
          echo "file=$FILE_NAME" >> $GITHUB_OUTPUT
          zip -r "./$FILE_NAME" \
            ./build \
            ./lang \
            ./node_modules \
            ./proto \
            ./public \
            ./LICENSE \
            ./package.json \
            ./package-lock.json \
            ./README.md \
            ./SECURITY.md \
            -x "./.git/*" \
            -x "./.github/*"

      - name: Generate SHA256 hash
        id: hash
        run: |
          HASH=$(sha256sum "${{ steps.zip.outputs.file }}" | awk '{print $1}')
          echo "sha=$HASH" >> $GITHUB_OUTPUT
          echo "âœ… File hash: $HASH"

      - name: Publish with GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
        run: |
          BODY_FILE="release_body.md"
          {
            echo "# ðŸ§¾ Release Notes"
            echo ""
            echo "## ðŸ“¦ Version"
            echo "\`${{ steps.version.outputs.version }}\`"
            echo ""
            echo "## ðŸ§© Changes"
            echo "${{ steps.changelog.outputs.changelog }}"
            echo ""
            echo "## ðŸ”’ Build Verification"
            echo "\`SHA256: ${{ steps.hash.outputs.sha }}\`"
            echo ""
            echo "_This changelog was automatically generated by CI._"
          } > "$BODY_FILE"
          
          FILE_NAME="${{ steps.repository.outputs.name }}@${{ steps.version.outputs.version }}.zip"

          gh release create "v${{ steps.version.outputs.version }}" "./$FILE_NAME" \
            --title "${{ steps.repository.outputs.name }} v${{ steps.version.outputs.version }}" \
            --notes-file "$BODY_FILE" \
            --generate-notes \
            --verify-tag